/*! For license information please see 916.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[916],{19856:function(e,t){var i;void 0===(i=function(){return function(){var e=i;e.Integer={type:"integer"};var t={String:String,Boolean:Boolean,Number:Number,Object:Object,Array:Array,Date:Date};function i(e,t){return i(e,t,{changing:!1})}e.validate=i,e.checkPropertyChange=function(e,t,n){return i(e,t,{changing:n||"property"})};var i=e._validate=function(e,i,n){n||(n={});var o=n.changing;function a(e){return e.type||t[e.name]==e&&e.name.toLowerCase()}var s=[];function r(e,t,i,c){var d;function u(e){s.push({property:i,message:e})}if(i+=i?"number"==typeof c?"["+c+"]":void 0===c?"":"."+c:c,("object"!=typeof t||t instanceof Array)&&(i||"function"!=typeof t)&&(!t||!a(t)))return"function"==typeof t?e instanceof t||u("is not an instance of the class/constructor "+t.name):t&&u("Invalid schema/property definition "+t),null;function p(e,t){if(e){if(!("string"!=typeof e||"any"==e||("null"==e?null===t:typeof t==e)||t instanceof Array&&"array"==e||t instanceof Date&&"date"==e||"integer"==e&&t%1==0))return[{property:i,message:typeof t+" value found, but a "+e+" is required"}];if(e instanceof Array){for(var n=[],o=0;o<e.length&&(n=p(e[o],t)).length;o++);if(n.length)return n}else if("object"==typeof e){var a=s;s=[],r(t,e,i);var l=s;return s=a,l}}return[]}if(o&&t.readonly&&u("is a readonly field, it can not be changed"),t.extends&&r(e,t.extends,i,c),void 0===e)t.required&&u("is missing and it is required");else if(s=s.concat(p(a(t),e)),t.disallow&&!p(t.disallow,e).length&&u(" disallowed value was matched"),null!==e){if(e instanceof Array){if(t.items){var h=t.items instanceof Array,g=t.items;for(c=0,d=e.length;c<d;c+=1)h&&(g=t.items[c]),n.coerce&&(e[c]=n.coerce(e[c],g)),s.concat(r(e[c],g,i,c))}t.minItems&&e.length<t.minItems&&u("There must be a minimum of "+t.minItems+" in the array"),t.maxItems&&e.length>t.maxItems&&u("There must be a maximum of "+t.maxItems+" in the array")}else(t.properties||t.additionalProperties)&&s.concat(l(e,t.properties,i,t.additionalProperties));if(t.pattern&&"string"==typeof e&&!e.match(t.pattern)&&u("does not match the regex pattern "+t.pattern),t.maxLength&&"string"==typeof e&&e.length>t.maxLength&&u("may only be "+t.maxLength+" characters long"),t.minLength&&"string"==typeof e&&e.length<t.minLength&&u("must be at least "+t.minLength+" characters long"),void 0!==typeof t.minimum&&typeof e==typeof t.minimum&&t.minimum>e&&u("must have a minimum value of "+t.minimum),void 0!==typeof t.maximum&&typeof e==typeof t.maximum&&t.maximum<e&&u("must have a maximum value of "+t.maximum),t.enum){var m,f=t.enum;d=f.length;for(var y=0;y<d;y++)if(f[y]===e){m=1;break}m||u("does not have a value in the enumeration "+f.join(", "))}"number"==typeof t.maxDecimal&&e.toString().match(new RegExp("\\.[0-9]{"+(t.maxDecimal+1)+",}"))&&u("may only have "+t.maxDecimal+" digits of decimal places")}return null}function l(e,t,i,a){if("object"==typeof t)for(var l in("object"!=typeof e||e instanceof Array)&&s.push({property:i,message:"an object is required"}),t)if(t.hasOwnProperty(l)){var c=e[l];if(void 0===c&&n.existingOnly)continue;var d=t[l];void 0===c&&d.default&&(c=e[l]=d.default),n.coerce&&l in e&&(c=e[l]=n.coerce(c,d)),r(c,d,i,l)}for(l in e){if(e.hasOwnProperty(l)&&("_"!=l.charAt(0)||"_"!=l.charAt(1))&&t&&!t[l]&&!1===a){if(n.filter){delete e[l];continue}s.push({property:i,message:typeof c+"The property "+l+" is not defined in the schema and the schema does not allow additional properties"})}var u=t&&t[l]&&t[l].requires;u&&!(u in e)&&s.push({property:i,message:"the presence of the property "+l+" requires that "+u+" also be present"}),c=e[l],!a||t&&"object"==typeof t&&l in t||(n.coerce&&(c=e[l]=n.coerce(c,a)),r(c,a,i,l)),!o&&c&&c.$schema&&(s=s.concat(r(c,c.$schema,i,l)))}return s}return i&&r(e,i,"",o||""),!o&&e&&e.$schema&&r(e,e.$schema,"",""),{valid:!s.length,errors:s}};return e.mustBeValid=function(e){if(!e.valid)throw new TypeError(e.errors.map((function(e){return"for property "+e.property+": "+e.message})).join(", \n"))},e}()}.apply(t,[]))||(e.exports=i)},73916:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>f});var n=i(69170),o=i(48913),a=i(97542),s=i(73339),r=i(54244),l=i(10374),c=i(19663);class d extends c.m{constructor(e,t,i){super(),this.payload={name:e,config:t,configMeta:i}}}class u extends c.m{constructor(e,t){super(),this.payload={operation:e,callback:t}}}var p=i(80361),h=i(19856),g=i(59279);class m{getFactory(e){return e.messengerFactory}}class f extends a.Y{constructor(){super(...arguments),this.name="plugin",this.data=new s.e,this.allowLoad=!1,this.allowInWorkshop=!0,this.onReloadPlugin=async({name:e,config:t,configMeta:i})=>{var n;if(!this.allowInWorkshop)return;const o=(await this.pluginConfigDataModule.getConfiguredPlugins()).find((t=>t.id===e));if(o){const e={properties:i,required:[]};for(const t of Object.keys(e.properties)){(null===(n=e.properties[t].required)||void 0===n?void 0:n.includes(t))&&e.required.push(t)}const a=(0,h.validate)(t,e);if(!a.valid)throw this.log.error(a.errors),new Error("disallowed config values, not reloading.");const s={applicationKey:o.applicationKey,id:o.id};await this.unload(s),await this.load(Object.assign(Object.assign({},o),{config:t}))}},this.debouncedOnReloadPlugin=(0,p.D)(this.onReloadPlugin,500),this.onReloadPluginCommand=async e=>{this.debouncedOnReloadPlugin(e)},this.onFetchSdkDataCommand=async e=>{const t=this.pluginConfigDataModule.serviceSdkKey;class i{constructor(e){this.sdk=e}connect(){return this.sdk.connectPlugin(t,"PluginConfigRootConnection")}cancelConnecting(){}}this.serviceSdkConnection||(this.serviceSdkConnection=await o.tK.connect(new i(this.sdk),new m,window));const[n,a]=e.operation.split(".");let s;try{s=await this.serviceSdkConnection[n][a]()}catch(t){throw new Error("Failed to run command: "+e.operation)}e.callback(s)}}async init(e,t){if(this.allowInWorkshop=!(0,g.eY)("preventWorkshopPluginPreview",!1,"boolean"),[this.ses,this.sdk,this.pluginConfigDataModule]=await Promise.all([t.getModuleBySymbol(n.y.SES),t.getModuleBySymbol(n.y.SDK),t.getModuleBySymbol(n.y.PLUGIN_CONFIG_DATA_MODULE)]),this.allowLoad=e.pluginPolicies.enabled,this.allowLoad){const e=t.subscribe(l.LZ,(async({phase:i,application:n})=>{i===r.nh.PLAYING&&(e.cancel(),this.allowInWorkshop?await this.loadConfigured():(this.log.devInfo("Reached PLAYING stage, checking whether configured plugins need to load to start: ",n),n===r.Mx.SHOWCASE&&await this.loadConfigured(),this.bindings.push(t.subscribe(l.pB,(async e=>{if(this.log.devInfo("Switch in active application detected by plugin system: ",e.application),e.application===r.Mx.WORKSHOP)try{await this.disposeAll()}catch(e){this.log.debugWarn("Entering workshop, one or more plugins failed to dispose properly:",e)}else e.application===r.Mx.SHOWCASE&&await this.loadConfigured()})))))}))}this.bindings.push(t.commandBinder.addBinding(d,this.onReloadPluginCommand),t.commandBinder.addBinding(u,this.onFetchSdkDataCommand)),t.market.register(this,s.e,this.data)}async loadConfigured(){if(this.pluginConfigDataModule.registryLoaded){const e=await this.pluginConfigDataModule.getConfiguredPlugins();if(this.log.debug("Combined configuration with registry data, loading plugins: "+JSON.stringify(e,void 0,2)),this.pluginConfigDataModule.pluginConfigData.disabled)return void this.log.debug("Cannot load plugins! Disabled by URL parameter.");const t=[];for(const i of e)t.push(this.load(i));try{await Promise.all(t)}catch(e){this.log.warn("Issues were encountered loading configured plugins.")}}}async fetchPlugin(e,t,i,n){n&&this.ses.freezeForStrict();const o=await this.ses.makeSecureEnvironment(e+""+(i?"-"+i:""),t,n);if(o){return[o,o.compartment.globalThis.plugin]}return null}async unload(e){const t=e.id&&""!==e.id?e.id:"default",i={applicationKey:e.applicationKey,id:t},n=this.data.get(i);let o=null;if(n){try{o=n.dispose()}catch(e){this.log.warn("An error occurred when disposing a plugin, it may be in a partially disposed state",e)}this.data.delete(i)}return o||Promise.resolve()}async load(e){const{applicationKey:t,src:i,id:n,strict:o}=e;if(!this.allowLoad){const e=i.startsWith("http")?i:`${i.substring(0,16)}...`;return Promise.reject(`Load for plugin <${n}:${e}> requested, but plugin system is not available.`)}const a=void 0===o||o,s=n||"default",r={applicationKey:t,id:s};if(this.data.get(r))return Promise.reject(`Plugin for ${t}-${s} already loaded.`);const[l,c]=await this.fetchPlugin(t,i,s,a)||[];l&&c&&await this.initPlugin(l,c.factory,e)}async initPlugin(e,t,i){const n=t(),{applicationKey:a,id:s,config:r}=i;let l=()=>{};const c=n.onInit||n.init;let d=Promise.resolve();if(c){class e{constructor(e){this.sdk=e}connect(){return this.sdk.connectPlugin(a,s)}cancelConnecting(){}}const t=await o.tK.connect(new e(this.sdk),new m,window);d=c.call(n,t,r),l=()=>t.disconnect()}async function u(){const t=n.onDestroy||n.dispose;return((null==t?void 0:t.call(n))||Promise.resolve()).finally((()=>{l(),e.dispose()}))}const p={applicationKey:a,id:s};try{return await d,this.data.set(p,n,u),Promise.resolve()}catch(e){this.log.warn("Plugin initialization failed: ",e),this.log.debugWarn("Attemptying dispose for clean up...");try{await u()}catch(e){this.log.warn("Auto-cleanup of plugin had errors: ",e)}return Promise.reject(e)}}dispose(e){super.dispose(e),this.disposeAll().catch((e=>{this.log.warn("One or more plugins failed to dispose properly.",e)}))}disposeAll(){const e=[];for(const[t,i]of this.data.plugins.entries())e.push(i.dispose());return this.data.plugins.clear(),Promise.all(e)}}}}]);